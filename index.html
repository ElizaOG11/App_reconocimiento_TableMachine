<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reconocimiento y conteo de útiles escolares</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    .box { border: 1px solid #ccc; padding: 15px; border-radius: 10px; width: 300px; }
    button { padding: 10px; margin-top: 10px; }
  </style>
</head>

<body>
  <h2>Reconocimiento y conteo de útiles escolares</h2>
  <p>Muestra <b>un objeto a la vez</b> a la cámara. Se contará solo si la confianza es alta (>90%).</p>

  <div id="webcam"></div>

  <div class="box">
    <h3>Predicción</h3>
    <p id="pred">Cargando modelo...</p>

    <button onclick="activarAuto()">Auto-conteo: <span id="estado">OFF</span></button>
    <button onclick="reiniciar()">Reiniciar conteo</button>

    <h3>Conteo</h3>
    <pre id="conteo">{}</pre>
  </div>

<script>
  const URL = "Model/";
  let model, webcam;
  let conteo = {};
  let auto = false;
  let ultimaSuma = 0;

  const UMBRAL = 0.90;
  const ESPERA = 1500;

  const NOMBRES = {
    "Marcador": "marcador",
    "marcador": "marcador",
    "Lápiz": "lápiz",
    "Lapiz": "lápiz",
    "lápiz": "lápiz",
    "lapiz": "lápiz",
    "Lapicero": "lapicero",
    "lapicero": "lapicero"
  };

  const CLASES = ["marcador", "lápiz", "lapicero"];

  async function iniciar() {
    try {
      model = await tmImage.load(URL + "model.json", URL + "metadata.json");

      webcam = new tmImage.Webcam(300, 300, false);
      await webcam.setup(); // aquí pide permiso de cámara
      await webcam.play();

      document.getElementById("webcam").innerHTML = "";
      document.getElementById("webcam").appendChild(webcam.canvas);

      document.getElementById("pred").innerText = "Modelo cargado. Muestra un objeto.";
      window.requestAnimationFrame(loop);
    } catch (e) {
      document.getElementById("pred").innerText =
        "❌ No se pudo abrir cámara o cargar el modelo. Revisa permisos y que existan Model/model.json y Model/metadata.json.";
      console.error(e);
    }
  }

  async function loop() {
    webcam.update();
    await predecir();
    window.requestAnimationFrame(loop);
  }

  async function predecir() {
    const predicciones = await model.predict(webcam.canvas);

    let mejor = predicciones[0];
    for (let p of predicciones) {
      if (p.probability > mejor.probability) mejor = p;
    }

    const clase = mejor.className;
    const conf = mejor.probability;

    const nombreMostrar = NOMBRES[clase] || clase;

    document.getElementById("pred").innerText =
      `Reconocimiento de ${nombreMostrar} (${(conf * 100).toFixed(1)}%)`;

    if (auto && conf >= UMBRAL) {
      const ahora = Date.now();
      if (ahora - ultimaSuma > ESPERA) {
        sumar(clase);
        ultimaSuma = ahora;
      }
    }
  }

  function sumar(claseOriginal) {
    const clase = NOMBRES[claseOriginal] || claseOriginal;
    conteo[clase] = (conteo[clase] || 0) + 1;

    const salida = {};
    for (const c of CLASES) salida[c] = conteo[c] || 0;

    document.getElementById("conteo").innerText = JSON.stringify(salida, null, 2);
  }

  function activarAuto() {
    auto = !auto;
    document.getElementById("estado").innerText = auto ? "ON" : "OFF";
  }

  function reiniciar() {
    conteo = {};
    document.getElementById("conteo").innerText = "{}";
  }

  iniciar();
</script>

</body>
</html>






