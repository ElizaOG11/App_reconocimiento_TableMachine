<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Contador de Objetos con IA</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    .box { border: 1px solid #ccc; padding: 15px; border-radius: 10px; width: 300px; }
    button { padding: 10px; margin-top: 10px; }
  </style>
</head>

<body>
  <h2>Contador de Objetos (Teachable Machine)</h2>
  <p>Muestra <b>un objeto a la vez</b> a la cámara. Se contará solo si la confianza es alta.</p>

  <div id="webcam"></div>

  <div class="box">
    <h3>Predicción</h3>
    <p id="pred">Cargando modelo...</p>

    <button onclick="activarAuto()">Auto-conteo: <span id="estado">OFF</span></button>
    <button onclick="reiniciar()">Reiniciar conteo</button>

    <h3>Conteo</h3>
    <pre id="conteo">{}</pre>
  </div>

<script>
  const URL = "model/";
  let model, webcam;
  let conteo = {};
  let auto = false;
  let ultimaSuma = 0;

  const UMBRAL = 0.90;      // 90%
  const ESPERA = 1500;     // milisegundos

  async function iniciar() {
    model = await tmImage.load(URL + "model.json", URL + "metadata.json");

    webcam = new tmImage.Webcam(300, 300, true);
    await webcam.setup();
    await webcam.play();
    window.requestAnimationFrame(loop);

    document.getElementById("webcam").appendChild(webcam.canvas);
  }

  async function loop() {
    webcam.update();
    await predecir();
    window.requestAnimationFrame(loop);
  }

  async function predecir() {
    const predicciones = await model.predict(webcam.canvas);

    let mejor = predicciones[0];
    for (let p of predicciones) {
      if (p.probability > mejor.probability) mejor = p;
    }

    document.getElementById("pred").innerText =
      `${mejor.className} (${(mejor.probability*100).toFixed(1)}%)`;

    if (auto && mejor.probability >= UMBRAL) {
      let ahora = Date.now();
      if (ahora - ultimaSuma > ESPERA) {
        sumar(mejor.className);
        ultimaSuma = ahora;
      }
    }
  }

  function sumar(clase) {
    conteo[clase] = (conteo[clase] || 0) + 1;
    document.getElementById("conteo").innerText =
      JSON.stringify(conteo, null, 2);
  }

  function activarAuto() {
    auto = !auto;
    document.getElementById("estado").innerText = auto ? "ON" : "OFF";
  }

  function reiniciar() {
    conteo = {};
    document.getElementById("conteo").innerText = "{}";
  }

  iniciar();
</script>
</body>
</html>
